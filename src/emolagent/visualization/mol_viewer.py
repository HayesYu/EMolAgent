"""
åˆ†å­å¯è§†åŒ–æ¨¡å—

ä½¿ç”¨ py3Dmol æä¾› Gaussian View é£æ ¼çš„åˆ†å­ç»“æ„å¯è§†åŒ–ã€‚
"""

import os
import json
import glob
from typing import Optional, List, Dict, Any, Tuple
from ase.db import connect
from ase import Atoms
import py3Dmol
import numpy as np

from emolagent.utils.logger import logger

# Element colors (CPK coloring scheme similar to Gaussian View)
ELEMENT_COLORS = {
    'H': '#FFFFFF',
    'C': '#909090',
    'N': '#3050F8',
    'O': '#FF0D0D',
    'F': '#90E050',
    'S': '#FFFF30',
    'P': '#FF8000',
    'Cl': '#1FF01F',
    'Br': '#A62929',
    'I': '#940094',
    'Li': '#8F40D4',
    'Na': '#AB5CF2',
    'K': '#8F40D4',
    'Mg': '#8AFF00',
    'Ca': '#3DFF00',
    'Fe': '#E06633',
    'Zn': '#7D80B0',
    'default': '#FF1493'
}

# Atom radii (in Angstroms, scaled for visualization)
ELEMENT_RADII = {
    'H': 0.31, 'C': 0.77, 'N': 0.71, 'O': 0.66, 'F': 0.57,
    'S': 1.05, 'P': 1.07, 'Cl': 1.02, 'Br': 1.20, 'I': 1.39,
    'Li': 1.34, 'Na': 1.54, 'K': 1.96, 'Mg': 1.30, 'Ca': 1.74,
    'Fe': 1.25, 'Zn': 1.22, 'default': 1.0
}


def atoms_to_xyz_string(atoms: Atoms, comment: str = "") -> str:
    """å°† ASE Atoms å¯¹è±¡è½¬æ¢ä¸º XYZ æ ¼å¼å­—ç¬¦ä¸²ã€‚"""
    n_atoms = len(atoms)
    lines = [str(n_atoms), comment]
    
    symbols = atoms.get_chemical_symbols()
    positions = atoms.get_positions()
    
    for sym, pos in zip(symbols, positions):
        lines.append(f"{sym:2s} {pos[0]:12.6f} {pos[1]:12.6f} {pos[2]:12.6f}")
    
    return "\n".join(lines)


def atomic_number_to_symbol(z: int) -> str:
    """å°†åŸå­åºæ•°è½¬æ¢ä¸ºå…ƒç´ ç¬¦å·ã€‚"""
    symbols = ['X', 'H', 'He', 'Li', 'Be', 'B', 'C', 'N', 'O', 'F', 'Ne',
               'Na', 'Mg', 'Al', 'Si', 'P', 'S', 'Cl', 'Ar', 'K', 'Ca',
               'Sc', 'Ti', 'V', 'Cr', 'Mn', 'Fe', 'Co', 'Ni', 'Cu', 'Zn',
               'Ga', 'Ge', 'As', 'Se', 'Br', 'Kr']
    if 0 <= z < len(symbols):
        return symbols[z]
    return 'X'


def create_gaussian_view_style_viewer(
    atoms: Atoms,
    width: int = 600,
    height: int = 500,
    style: str = "sphere+stick",
    background_color: str = "#1a1a2e",
    show_labels: bool = False,
    add_lighting: bool = True,
) -> str:
    """
    åˆ›å»º Gaussian View é£æ ¼çš„ 3D åˆ†å­æŸ¥çœ‹å™¨ HTMLã€‚
    
    Args:
        atoms: ASE Atoms å¯¹è±¡
        width: æŸ¥çœ‹å™¨å®½åº¦ï¼ˆåƒç´ ï¼‰
        height: æŸ¥çœ‹å™¨é«˜åº¦ï¼ˆåƒç´ ï¼‰
        style: æ¸²æŸ“æ ·å¼ ("sphere", "stick", "sphere+stick")
        background_color: èƒŒæ™¯é¢œè‰²
        show_labels: æ˜¯å¦æ˜¾ç¤ºåŸå­æ ‡ç­¾
        add_lighting: æ˜¯å¦æ·»åŠ å¢å¼ºå…‰ç…§æ•ˆæœ
        
    Returns:
        åŒ…å«äº¤äº’å¼ 3D æŸ¥çœ‹å™¨çš„ HTML å­—ç¬¦ä¸²
    """
    xyz_str = atoms_to_xyz_string(atoms, "Generated by EMolAgent")
    
    viewer = py3Dmol.view(width=width, height=height)
    viewer.addModel(xyz_str, "xyz")
    
    if style == "sphere":
        viewer.setStyle({'sphere': {'colorscheme': 'Jmol', 'scale': 0.3}})
    elif style == "stick":
        viewer.setStyle({
            'stick': {'radius': 0.15, 'colorscheme': 'Jmol'},
        })
    else:
        viewer.setStyle({
            'sphere': {'colorscheme': 'Jmol', 'scale': 0.25},
            'stick': {'radius': 0.12, 'colorscheme': 'Jmol'}
        })
    
    viewer.setBackgroundColor(background_color)
    
    if show_labels:
        viewer.addPropertyLabels('elem', '', {'fontSize': 12, 'fontColor': 'white', 'showBackground': False})
    
    viewer.zoomTo()
    
    html = viewer._make_html()
    
    wrapper_html = f"""
    <div style="border: 2px solid #4a4a6a; border-radius: 8px; padding: 10px; background: #0d0d1a;">
        <div style="color: #aaa; font-size: 12px; margin-bottom: 5px; text-align: center;">
            ğŸ–±ï¸ å·¦é”®æ‹–åŠ¨æ—‹è½¬ | æ»šè½®ç¼©æ”¾ | å³é”®å¹³ç§»
        </div>
        {html}
        <div style="color: #888; font-size: 11px; margin-top: 5px; text-align: center;">
            åŸå­æ•°: {len(atoms)} | åŒ–å­¦å¼: {atoms.get_chemical_formula()}
        </div>
    </div>
    """
    
    return wrapper_html


def load_structure_from_db(db_path: str, index: int = 0) -> Optional[Atoms]:
    """ä» ASE æ•°æ®åº“åŠ è½½ç»“æ„ã€‚"""
    if not os.path.exists(db_path):
        return None
    
    try:
        with connect(db_path) as db:
            if db.count() == 0:
                return None
            row = list(db.select())[index]
            return row.toatoms()
    except Exception as e:
        logger.error(f"Error loading structure: {e}")
        return None


def create_orbital_viewer(
    cube_path: str,
    width: int = 600,
    height: int = 500,
    iso_value: float = 0.02,
    orbital_type: str = "HOMO",
    background_color: str = "#1a1a2e",
) -> str:
    """
    åˆ›å»ºåˆ†å­è½¨é“ï¼ˆcube æ–‡ä»¶ï¼‰å¯è§†åŒ–æŸ¥çœ‹å™¨ã€‚
    
    Args:
        cube_path: cube æ–‡ä»¶è·¯å¾„
        width: æŸ¥çœ‹å™¨å®½åº¦
        height: æŸ¥çœ‹å™¨é«˜åº¦
        iso_value: ç­‰å€¼é¢æ•°å€¼
        orbital_type: è½¨é“ç±»å‹ ("HOMO" æˆ– "LUMO")
        background_color: èƒŒæ™¯é¢œè‰²
        
    Returns:
        åŒ…å«äº¤äº’å¼ 3D è½¨é“æŸ¥çœ‹å™¨çš„ HTML å­—ç¬¦ä¸²
    """
    if not os.path.exists(cube_path):
        return f"<p style='color: red;'>Cube æ–‡ä»¶ä¸å­˜åœ¨: {cube_path}</p>"
    
    try:
        with open(cube_path, 'r') as f:
            cube_content = f.read()
        
        viewer = py3Dmol.view(width=width, height=height)
        
        if orbital_type.upper() == "HOMO":
            pos_color = "#1E90FF"
            neg_color = "#FF6347"
        else:
            pos_color = "#32CD32"
            neg_color = "#FFD700"
        
        viewer.addVolumetricData(cube_content, "cube", {
            'isoval': iso_value,
            'color': pos_color,
            'opacity': 0.75,
            'smoothness': 3
        })
        viewer.addVolumetricData(cube_content, "cube", {
            'isoval': -iso_value,
            'color': neg_color,
            'opacity': 0.75,
            'smoothness': 3
        })
        
        viewer.addModel(cube_content, "cube")
        viewer.setStyle({
            'sphere': {'colorscheme': 'Jmol', 'scale': 0.2},
            'stick': {'radius': 0.1, 'colorscheme': 'Jmol'}
        })
        
        viewer.setBackgroundColor(background_color)
        viewer.zoomTo()
        
        html = viewer._make_html()
        
        wrapper_html = f"""
        <div style="border: 2px solid #4a4a6a; border-radius: 8px; padding: 10px; background: #0d0d1a;">
            <div style="color: #aaa; font-size: 12px; margin-bottom: 5px; text-align: center;">
                ğŸ–±ï¸ å·¦é”®æ‹–åŠ¨æ—‹è½¬ | æ»šè½®ç¼©æ”¾ | å³é”®å¹³ç§»
            </div>
            {html}
            <div style="color: #888; font-size: 11px; margin-top: 5px; text-align: center;">
                {orbital_type} è½¨é“ | ç­‰å€¼é¢: Â±{iso_value} &nbsp;
                <span style="color: {pos_color};">â– </span> æ­£ç›¸ä½ &nbsp;
                <span style="color: {neg_color};">â– </span> è´Ÿç›¸ä½
            </div>
        </div>
        """
        
        return wrapper_html
        
    except Exception as e:
        return f"<p style='color: red;'>åŠ è½½è½¨é“å¯è§†åŒ–å¤±è´¥: {e}</p>"


def find_orbital_files(inference_dir: str) -> Dict[str, Optional[str]]:
    """åœ¨æ¨æ–­ç»“æœç›®å½•ä¸­æŸ¥æ‰¾ HOMO å’Œ LUMO cube æ–‡ä»¶ã€‚"""
    result: Dict[str, Optional[str]] = {'homo': None, 'lumo': None}
    
    if not os.path.exists(inference_dir):
        return result
    
    search_patterns = [
        os.path.join(inference_dir, "results", "*", "homo.cube"),
        os.path.join(inference_dir, "results", "*", "lumo.cube"),
        os.path.join(inference_dir, "*", "homo.cube"),
        os.path.join(inference_dir, "*", "lumo.cube"),
        os.path.join(inference_dir, "homo.cube"),
        os.path.join(inference_dir, "lumo.cube"),
    ]
    
    for pattern in search_patterns:
        matches = glob.glob(pattern)
        for match in matches:
            basename = os.path.basename(match).lower()
            if 'homo' in basename and result['homo'] is None:
                result['homo'] = match
            elif 'lumo' in basename and result['lumo'] is None:
                result['lumo'] = match
    
    return result


def find_li_deformation_files(inference_dir: str) -> List[Dict[str, str]]:
    """
    åœ¨æ¨æ–­ç»“æœç›®å½•ä¸­æŸ¥æ‰¾ Li deformation surface PDB æ–‡ä»¶ã€‚
    
    æ–‡ä»¶åæ ¼å¼: Li_infer_{id}_diff{isovalue}_surface.pdb
    
    Returns:
        åŒ…å« 'path', 'id', 'isovalue' é”®çš„å­—å…¸åˆ—è¡¨
    """
    result: List[Dict[str, str]] = []
    
    if not os.path.exists(inference_dir):
        return result
    
    search_patterns = [
        os.path.join(inference_dir, "results", "*", "Li_*_surface.pdb"),
        os.path.join(inference_dir, "*", "Li_*_surface.pdb"),
        os.path.join(inference_dir, "Li_*_surface.pdb"),
    ]
    
    found_files = set()
    for pattern in search_patterns:
        matches = glob.glob(pattern)
        for match in matches:
            if match not in found_files:
                found_files.add(match)
                basename = os.path.basename(match)
                # è§£ææ–‡ä»¶å: Li_infer_1_diff0p09_surface.pdb
                import re
                m = re.match(r'Li_(\w+)_(\d+)_diff(\w+)_surface\.pdb', basename)
                if m:
                    result.append({
                        'path': match,
                        'type': m.group(1),  # infer/pred/target
                        'id': m.group(2),
                        'isovalue': m.group(3).replace('p', '.'),  # 0p09 -> 0.09
                    })
    
    # æŒ‰ id æ’åº
    result.sort(key=lambda x: int(x.get('id', 0)))
    return result


def create_li_deformation_viewer(
    molecule_path: str,
    surface_pdb_path: str,
    width: int = 600,
    height: int = 500,
    surface_color: str = "#4A90D9",
    surface_opacity: float = 0.65,
    background_color: str = "#1a1a2e",
    isovalue: str = "0.09",
) -> str:
    """
    åˆ›å»º Li deformation factor å¯è§†åŒ–æŸ¥çœ‹å™¨ã€‚
    
    å°†ç‚¹äº‘ PDB æ¸²æŸ“ä¸ºåŠé€æ˜è¡¨é¢ï¼Œå åŠ åœ¨åˆ†å­ç»“æ„ä¸Šï¼Œ
    ç”¨äºå±•ç¤º Li ç¦»å­å‘¨å›´çš„ç”µå­å˜å½¢åˆ†å¸ƒã€‚
    
    Args:
        molecule_path: åˆ†å­ç»“æ„æ–‡ä»¶è·¯å¾„ (xyz æˆ– pdb)
        surface_pdb_path: Li deformation ç‚¹äº‘ PDB æ–‡ä»¶è·¯å¾„
        width: æŸ¥çœ‹å™¨å®½åº¦
        height: æŸ¥çœ‹å™¨é«˜åº¦
        surface_color: è¡¨é¢é¢œè‰²ï¼ˆé»˜è®¤å†·è“è‰²ï¼‰
        surface_opacity: è¡¨é¢é€æ˜åº¦
        background_color: èƒŒæ™¯é¢œè‰²
        isovalue: ç­‰å€¼é¢å€¼ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        
    Returns:
        åŒ…å«äº¤äº’å¼ 3D æŸ¥çœ‹å™¨çš„ HTML å­—ç¬¦ä¸²
    """
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(molecule_path):
        return f"<p style='color: red;'>åˆ†å­ç»“æ„æ–‡ä»¶ä¸å­˜åœ¨: {molecule_path}</p>"
    if not os.path.exists(surface_pdb_path):
        return f"<p style='color: red;'>è¡¨é¢ç‚¹äº‘æ–‡ä»¶ä¸å­˜åœ¨: {surface_pdb_path}</p>"
    
    try:
        # 1. è¯»å–åˆ†å­ç»“æ„
        mol_ext = os.path.splitext(molecule_path)[1].lower()
        with open(molecule_path, 'r') as f:
            mol_content = f.read()
        
        # ç¡®å®šåˆ†å­æ–‡ä»¶æ ¼å¼
        if mol_ext == '.xyz':
            mol_format = 'xyz'
        elif mol_ext == '.pdb':
            mol_format = 'pdb'
        else:
            # å°è¯•è‡ªåŠ¨æ£€æµ‹
            mol_format = 'xyz' if mol_content.strip().split('\n')[0].strip().isdigit() else 'pdb'
        
        # 2. è¯»å–è¡¨é¢ç‚¹äº‘ PDB
        with open(surface_pdb_path, 'r') as f:
            surface_content = f.read()
        
        # 3. åˆ›å»º py3Dmol è§†å›¾
        viewer = py3Dmol.view(width=width, height=height)
        
        # 4. æ·»åŠ åˆ†å­éª¨æ¶ (Model 0)
        viewer.addModel(mol_content, mol_format)
        viewer.setStyle({'model': 0}, {
            'sphere': {'colorscheme': 'Jmol', 'scale': 0.25},
            'stick': {'radius': 0.12, 'colorscheme': 'Jmol'}
        })
        
        # 5. æ·»åŠ ç‚¹äº‘å¹¶æ¸²æŸ“ä¸ºè¡¨é¢ (Model 1)
        viewer.addModel(surface_content, 'pdb')
        # éšè—ç‚¹äº‘æœ¬èº«çš„åŸå­æ˜¾ç¤º
        viewer.setStyle({'model': 1}, {'sphere': {'scale': 0}})
        
        # 6. ä¸ºç‚¹äº‘æ·»åŠ  VDW è¡¨é¢ï¼ˆè¿‘ä¼¼ QuickSurf æ•ˆæœï¼‰
        # py3Dmol çš„ addSurface æ”¯æŒ: VDW, MS (åˆ†å­è¡¨é¢), SAS, SES
        viewer.addSurface(
            'VDW',
            {
                'opacity': surface_opacity,
                'color': surface_color,
            },
            {'model': 1}
        )
        
        # 7. è®¾ç½®èƒŒæ™¯å’Œè§†å›¾
        viewer.setBackgroundColor(background_color)
        viewer.zoomTo()
        
        # 8. ç”Ÿæˆ HTML
        html = viewer._make_html()
        
        wrapper_html = f"""
        <div style="border: 2px solid #4a4a6a; border-radius: 8px; padding: 10px; background: #0d0d1a;">
            <div style="color: #aaa; font-size: 12px; margin-bottom: 5px; text-align: center;">
                ğŸ–±ï¸ å·¦é”®æ‹–åŠ¨æ—‹è½¬ | æ»šè½®ç¼©æ”¾ | å³é”®å¹³ç§»
            </div>
            {html}
            <div style="color: #888; font-size: 11px; margin-top: 5px; text-align: center;">
                Li Deformation Factor | ç­‰å€¼é¢: {isovalue} &nbsp;
                <span style="display: inline-block; width: 12px; height: 12px; background: {surface_color}; border-radius: 2px; vertical-align: middle;"></span>
                <span style="color: {surface_color};"> å˜å½¢åŒºåŸŸ</span>
            </div>
        </div>
        """
        
        return wrapper_html
        
    except Exception as e:
        return f"<p style='color: red;'>åŠ è½½ Li Deformation å¯è§†åŒ–å¤±è´¥: {e}</p>"


def create_structure_preview_html(db_path: str, max_structures: int = 3) -> str:
    """ä¸ºæ•°æ®åº“ä¸­çš„ç»“æ„åˆ›å»º HTML é¢„è§ˆã€‚"""
    if not os.path.exists(db_path):
        return "<p style='color: red;'>ç»“æ„æ–‡ä»¶ä¸å­˜åœ¨</p>"
    
    try:
        with connect(db_path) as db:
            count = db.count()
            
            if count == 0:
                return "<p style='color: orange;'>æ•°æ®åº“ä¸­æ²¡æœ‰ç»“æ„</p>"
            
            html_parts = []
            html_parts.append(f"<div style='text-align: center; color: #888;'>å…± {count} ä¸ªç»“æ„</div>")
            
            for i, row in enumerate(db.select()):
                if i >= max_structures:
                    html_parts.append(f"<p style='color: #888; text-align: center;'>... è¿˜æœ‰ {count - max_structures} ä¸ªç»“æ„</p>")
                    break
                
                atoms = row.toatoms()
                name = row.get('name', f'Structure {i+1}')
                
                viewer_html = create_gaussian_view_style_viewer(
                    atoms, 
                    width=500, 
                    height=400,
                    style="sphere+stick"
                )
                
                html_parts.append(f"""
                <div style="margin: 15px 0; padding: 10px; border: 1px solid #333; border-radius: 8px;">
                    <h4 style="color: #fff; margin: 0 0 10px 0;">{name}</h4>
                    {viewer_html}
                </div>
                """)
            
            return "\n".join(html_parts)
            
    except Exception as e:
        return f"<p style='color: red;'>åŠ è½½ç»“æ„å¤±è´¥: {e}</p>"


def create_analysis_visualization_html(
    db_path: str,
    inference_dir: str,
    width: int = 600,
    height: int = 450
) -> Dict[str, Any]:
    """
    åˆ›å»ºç»“æ„ã€HOMOã€LUMO çš„å¯è§†åŒ– HTMLã€‚
    
    Returns:
        åŒ…å« 'structure', 'homo', 'lumo' é”®çš„å­—å…¸
    """
    result: Dict[str, Any] = {
        'structure': None,
        'homo': None,
        'lumo': None,
        'structure_available': False,
        'homo_available': False,
        'lumo_available': False
    }
    
    if db_path and os.path.exists(db_path):
        try:
            atoms = load_structure_from_db(db_path)
            if atoms:
                result['structure'] = create_gaussian_view_style_viewer(
                    atoms, width=width, height=height, style="sphere+stick"
                )
                result['structure_available'] = True
        except Exception as e:
            result['structure'] = f"<p style='color: orange;'>ç»“æ„åŠ è½½å¤±è´¥: {e}</p>"
    
    orbital_files = find_orbital_files(inference_dir)
    
    if orbital_files['homo']:
        result['homo'] = create_orbital_viewer(
            orbital_files['homo'], 
            width=width, 
            height=height,
            iso_value=0.02,
            orbital_type="HOMO"
        )
        result['homo_available'] = True
    
    if orbital_files['lumo']:
        result['lumo'] = create_orbital_viewer(
            orbital_files['lumo'],
            width=width,
            height=height, 
            iso_value=0.02,
            orbital_type="LUMO"
        )
        result['lumo_available'] = True
    
    return result


def generate_high_quality_image(
    atoms: Atoms,
    output_path: str,
    width: int = 1200,
    height: int = 900,
    style: str = "sphere+stick"
) -> str:
    """ç”Ÿæˆé«˜è´¨é‡åˆ†å­é™æ€å›¾åƒã€‚"""
    html_content = create_gaussian_view_style_viewer(atoms, width, height, style)
    
    html_path = output_path.replace('.png', '.html')
    with open(html_path, 'w') as f:
        f.write(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Molecular Structure</title>
            <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
        </head>
        <body style="margin: 0; padding: 0; background: #1a1a2e;">
            {html_content}
        </body>
        </html>
        """)
    
    return html_path
